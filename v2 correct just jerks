import tkinter as tk
from adafruit_servokit import ServoKit
import threading
import time

# Initialize PCA9685
kit = ServoKit(channels=16)

# Servo channels
BASE = 0
THIGH = 1
INDEFECTOR = 2
GRIPPER = 3

# Default neutral angle
NEUTRAL_ANGLE = 90

# Track current angle
current_angle = {
    BASE: NEUTRAL_ANGLE,
    THIGH: NEUTRAL_ANGLE,
    INDEFECTOR: NEUTRAL_ANGLE,
    GRIPPER: NEUTRAL_ANGLE
}

# Initialize servos to neutral
for ch in current_angle:
    kit.servo[ch].angle = NEUTRAL_ANGLE

# Function to set servo safely
def set_servo_angle(channel, angle):
    angle = max(0, min(180, angle))
    kit.servo[channel].angle = angle
    current_angle[channel] = angle

# Pulse servo with custom step and duration
def pulse_servo(channel, step, duration=0.2):
    """Move servo a single step and return to current position."""
    def move():
        target = max(0, min(180, current_angle[channel] + step))
        kit.servo[channel].angle = target
        time.sleep(duration / 2)
        kit.servo[channel].angle = current_angle[channel]
        time.sleep(duration / 2)
    threading.Thread(target=move).start()

# Continuous movement
running_flags = {}  # keeps track of continuous movement per button

def start_continuous(channel, step):
    """Start continuous movement for button hold."""
    running_flags[channel] = True
    def move():
        while running_flags.get(channel, False):
            target = max(0, min(180, current_angle[channel] + step))
            kit.servo[channel].angle = target
            time.sleep(speed_slider.get() / 1000 / 2)
            kit.servo[channel].angle = current_angle[channel]
            time.sleep(speed_slider.get() / 1000 / 2)
    threading.Thread(target=move).start()

def stop_continuous(channel):
    running_flags[channel] = False

# GUI
root = tk.Tk()
root.title("3-Rotor Arm + Gripper Control")

tk.Label(root, text="Sliders for continuous control").grid(row=0, column=0, columnspan=2, pady=5)
tk.Label(root, text="Pulse buttons for small steps").grid(row=0, column=2, columnspan=2, pady=5)

# Servo sliders
def create_slider(row, label_text, channel):
    tk.Label(root, text=label_text).grid(row=row, column=0, padx=5, pady=5)
    slider = tk.Scale(root, from_=0, to=180, orient=tk.HORIZONTAL,
                      command=lambda val: set_servo_angle(channel, int(val)))
    slider.set(NEUTRAL_ANGLE)
    slider.grid(row=row, column=1, padx=5, pady=5)
    return slider

base_slider = create_slider(1, "Base", BASE)
thigh_slider = create_slider(2, "Thigh", THIGH)
indef_slider = create_slider(3, "Indefector", INDEFECTOR)
gripper_slider = create_slider(4, "Gripper", GRIPPER)

# Speed slider: 50ms (fast) to 500ms (slow)
tk.Label(root, text="Pulse Duration / Speed (ms, lower=faster)").grid(row=5, column=0, padx=5, pady=10)
speed_slider = tk.Scale(root, from_=50, to=500, orient=tk.HORIZONTAL)
speed_slider.set(200)  # default 200ms
speed_slider.grid(row=5, column=1, padx=5, pady=10)

# Button creation helper
def create_pulse_button(text, channel, step, row, col):
    btn = tk.Button(root, text=text)
    # Single click
    btn.config(command=lambda: pulse_servo(channel, step, duration=speed_slider.get()/1000))
    # Continuous hold
    btn.bind('<ButtonPress>', lambda e: start_continuous(channel, step))
    btn.bind('<ButtonRelease>', lambda e: stop_continuous(channel))
    btn.grid(row=row, column=col, padx=5, pady=5)
    return btn

# Base
create_pulse_button("Base Left", BASE, -12, 1, 2)
create_pulse_button("Base Right", BASE, +10, 1, 3)
# Thigh (swapped)
create_pulse_button("Thigh Down", THIGH, +10, 2, 2)  # swapped label
create_pulse_button("Thigh Up", THIGH, -12, 2, 3)    # swapped label
# Indefector
create_pulse_button("Indefector Up", INDEFECTOR, +10, 3, 2)
create_pulse_button("Indefector Down", INDEFECTOR, -12, 3, 3)
# Gripper
create_pulse_button("Gripper Front", GRIPPER, +10, 4, 2)
create_pulse_button("Gripper Back", GRIPPER, -10, 4, 3)



root.mainloop()
